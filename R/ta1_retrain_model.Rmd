---
title: "Train HICEAS 2017 BANTER Model"
author: "Selene Fregosi"
date: "`r format(Sys.time(), '%d %B %Y')`"
geometry: margin = 1cm
output:
  html_document:
    toc: yes
    toc_float: yes
    toc_depth: 4
    # code_folding: hide
    # keep_md: yes
editor_options:
  chunk_output_type: console
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      # cache = FALSE, 
                      # warning = FALSE, 
                      message = FALSE
)
```

## Purpose

The HICEAS 2017 towed array BANTER model was originally created in 2021. The `banter` package underwent some significant changes since then that makes summarizing/plotting the old model throw errors. The purpose of this script is to re-generate the HICEAS 2017 towed array model using all the same data, but just with the more recent version of `banter`. The results are identical. 

The steps here are based off the `BANTER_HICEAS_TA_EditedEVT_577.pdf` generated by an .Rmd I don't have access to, dated 2021-08-09. 


## Set up

### Load libraries
```{r libraries}
library(banter)
library(rfPermute)
library(ggplot2)
```

### Set paths and run type
```{r set-paths}
# path to save models
path_models <- file.path('T:/glider_MHI_analysis', 'classification', 'models', 
                         'HICEAS_BANTER')

# Re-generate/train model (1) or load existing model to view results (0)
freshRun <- 1
```

### Load training data 

Alternatively, if this is not a fresh run to train a new model, load an existing model and just look at the results. 
```{r load-data}
# load data - banterAllsmall
# load(file = file.choose())
# load('R:/McCullough/PAMpal/Banter_TowedArray_Data/banterAllsmall_HICEAS2017-CH5_Filtered-577.rdata')

if (freshRun == 1){
  trainingFile <- 'R:/McCullough/PAMpal/Banter_TowedArray_Data/banterAllsmall_HICEAS2017-CH5_Filtered-577.rdata'
  load(trainingFile)
} else if (freshRun == 0){
  modelFile <- file.path(path_models, 'bantMDL_HICEAS2017-CH5_Filtered_577_2024-05-20.rdata')
  load(modelFile)
  cat('Loaded existing model:', modelFile, '\n')
}

```

## Build the model
```{r build}
# the PDF says no click_detector_0 detections were included but I see them in 
# the banterAllsmall list -- THEY ARE EXCLUDED BELOW
# View(banterAllsmall$detectors)

if (freshRun == 1){
  # build the model
  bant.mdl <- initBanterModel(banterAllsmall$events)
  bant.mdl <- addBanterDetector(
    bant.mdl,
    data = banterAllsmall$detectors[c(2,3,4,5,6,7,8)], # excludes click_detector_0
    ntree = 5000,
    sampsize = 15
  )
  bant.mdl <- runBanterModel(bant.mdl, ntree = 10000, sampsize = 15)
  
  # save model
  save(bant.mdl, file = file.path(path_models, paste0('bantMDL_HICEAS2017-CH5_Filtered_577_',
                                                   Sys.Date(), '.rdata')))
  # get random forest data and save
  event.rf <- getBanterModel(bant.mdl, "event")
  save(event.rf, file = file.path(path_models, paste0('eventRF_HICEAS2017-CH5_Filtered_577_',
                                                   Sys.Date(), '.rdata')))
} else if (freshRun == 0){
  event.rf <- getBanterModel(bant.mdl, "event")
  cat('No model trained. Showing results from existing model:', modelFile, '\n')
}

```

## View results

### Overall results (event model)
```{r results-overall}

summary(bant.mdl)
plotVotes(event.rf)
plotProximity(event.rf)

```

### Detector results (detector models)
```{r results-detectors}
detList <- names(bant.mdl@detectors)

for (d in seq_along(detList)){
  cat(detList[d], '\n')
  plotTrace(getBanterModel(bant.mdl, model = detList[d]))
  #plotInbag(getBanterModel(bant.mdl, model = d))
  # print(table(getBanterModel(bant.mdl, model = d)$oob.times))
}

```
