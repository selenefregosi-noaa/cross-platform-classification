---
title: "Train Longline BANTER Model"
author: "Selene Fregosi"
date: "`r format(Sys.time(), '%d %B %Y')`"
geometry: margin = 1cm
output:
  html_document:
    toc: yes
    toc_float: yes
    toc_depth: 4
    # code_folding: hide
    # keep_md: yes
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      # cache = FALSE, 
                      # warning = FALSE, 
                      message = FALSE
)
```

## Purpose

An initial Longline HARP BANTER model has been created as part of the Simonis et al. (in submission) manuscript, however, this model  (`LLHARP_BANTER_2class_2023-05-31.rda`) does not include the same filtering as the towed array model and only includes data from longline trips through 2020. The purpose of this script is to generate an updated Longline BANTER model with some additional events from Phase 3 of the Longline Acoustic Montoring Project, some Phase 1 and 2 trips removed due to noise or other uncertainties, and with some processing adjustments to match that of the towed array model (include filtering of click detectors and remove calibration).

## Set up

### Load libraries
```{r libraries}
library(banter)
library(rfPermute)
library(ggplot2)
```

### Set paths and run type
```{r set-paths}
# path to save models
# path_models <- file.path('T:/glider_MHI_analysis', 'classification', 'models')
# path_models <- file.path('Z:/LLHARP/analysis/banterModels')
path_models <- file.path('T:/fregosi/cross_platform_banter_big_data/models')

# Re-generate/train model (1) or load existing model to view results (0)
freshRun <- 1
```

## Load training data

Training data was created with `ll1_combine_acoustic_studies.R`. 

Alternatively, if this is not a fresh run to train a new model, load an existing model and just look at the results. 

If loading `TrainingDataset_Pc_UO_Pm2023-05-30_edited.rda`, events are labeled Pc, UO and Pm. This `.rda` file is already exported for `banter`. 

```{r load-data}
# load(file = file.choose())
# load('Z:/LLHARP/processingCode/LLHARP/data/TrainingDataset_Pc_UO_Pm2023-05-30_edited.rda')
# load('Z:/LLHARP/processingCode/LLHARP/data/AllEventsTBP_Pc_UO_Pm2023-05-30_edited.rda')


if (freshRun == 1){
  # trainingFile <- file.path('Z:/LLHARP/analysis/banter2024/simonis_data',
  #                           'TrainingDataset_Pc_UO_Pm2023-05-30_edited.rda')
  trainingFile <- file.path('T:/fregosi/cross_platform_banter_big_data', 
                            'banterDetsTrain_LLHARP_2024-05-27.rda')
  load(trainingFile)
  # load to-be-predicted file
  # TBPFile <-'Z:/LLHARP/analysis/banter2024/simonis_data/AllEvents_TBP_Pc_UO_Pm2023-05-30.rda'
  # load(TBPFile)
} else if (freshRun == 0){
  modelFile <- file.path(path_models, 'LLHARP_BANTER_2class_2023-05-31.rda')
  load(modelFile)
  cat('Loaded existing model:', modelFile, '\n')
}


```

## Clean data

If the training data contains species other than just `Pc` or `UO`, they need to be cleaned up. Replace all non-Pc entries with `UO`. 

Also, remove any 'Click_Detector_0' detections. 

```{r clean}

uSp <- unique(banterDetsTrain$events$species)
uSp <- uSp[-which(uSp == 'UO' | uSp == 'Pc')]

for (u in seq_along(uSp)){
  uSpIdx <- which(banterDetsTrain$events$species == uSp[u])
  banterDetsTrain$events$species[uSpIdx] <- 'UO'
}

# unique(banterDetsTrain$events$species)

# Check for click_detector_0 in training dataset
banterDetsTrain$detectors$Click_Detector_0 <- NULL

```

## Build the model
```{r build}


if (freshRun == 1){
  # build the model
  bant.mdl <- initBanterModel(banterDetsTrain$events)
  bant.mdl <- addBanterDetector(
    bant.mdl,
    data =  banterDetsTrain$detectors, 
    ntree = 5000,
    sampsize = 8
  )
  bant.mdl <- runBanterModel(bant.mdl, ntree = 10000, sampsize = 8)
  
  # save model
  save(bant.mdl, file = file.path(path_models, paste0('bantMDL_LLHARP_',
                                                      Sys.Date(), '.rda')))
  # get random forest data and save
  event.rf <- getBanterModel(bant.mdl, "event")
  save(event.rf, file = file.path(path_models, paste0('eventRF_LLHARP_',
                                                      Sys.Date(), '.rdata')))
} else if (freshRun == 0){
  event.rf <- getBanterModel(bant.mdl, "event")
  cat('No model trained. Showing results from existing model:', modelFile, '\n')
}

```



